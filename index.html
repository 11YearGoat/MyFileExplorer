<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF‚Äë8"/>
  <meta name="viewport" content="width=device-width, initial‚Äëscale=1.0"/>
  <title>AdVault Explorer</title>
  <link rel="manifest" href="manifest.json"/>
  <link rel="icon" href="icon.png"/>
  <style>
    body {
      margin:0; padding:0;
      background:#111; color:#00ffaa;
      font-family: monospace;
      display:flex; flex-direction:column;
      align-items:center; height:100vh;
      padding:20px;
    }
    h1 { margin:0; padding:10px; font-size:1.8em; }
    button {
      margin:10px; padding:10px 20px;
      background:#00ffaa; border:none;
      color:#000; border-radius:5px;
      font-weight:bold; cursor:pointer;
    }
    button:hover { background:#00ffcc; }
    ul {
      width:90%; max-width:600px;
      height:60vh; overflow:auto;
      padding:0; list-style:none;
      border:1px solid #333;
      backdrop-filter:blur(5px);
      background-color: rgba(0, 0, 0, 0.2);
    }
    li {
      padding:8px; border-bottom:1px solid #333;
      cursor:pointer;
    }
    li:hover { background:#004444; }
  </style>
</head>
<body>
  <h1>üìÇ AdVault Explorer</h1>
  <button onclick="openFolder(true)">Pick Folder</button>
  <button onclick="goBack()">‚¨ÖÔ∏è Up</button>
  <ul id="list"></ul>

  <script>
  let currentHandle = null;
  const stack = [];

  async function showDirectory(handle) {
    currentHandle = handle;
    const list = document.getElementById('list');
    list.innerHTML = '';
    for await (const [name, h] of handle.entries()) {
      const li = document.createElement('li');
      li.textContent = h.kind === 'directory' ? name + '/' : name;
      li.onclick = () => {
        if (h.kind === 'directory') {
          stack.push(handle);
          showDirectory(h);
        } else {
          previewFile(h);
        }
      };
      list.appendChild(li);
    }
  }

  async function openFolder(reset = false) {
    const handle = await window.showDirectoryPicker();
    stack.length = 0;
    saveHandle(handle);
    showDirectory(handle);
  }

  async function goBack() {
    if (stack.length) {
      const parent = stack.pop();
      showDirectory(parent);
    }
  }

  async function previewFile(handle) {
    const file = await handle.getFile();
    alert(`File: ${file.name}\nSize: ${file.size} bytes`);
  }

  function saveHandle(handle) {
    const dbReq = indexedDB.open('advaultDB', 1);
    dbReq.onupgradeneeded = e => {
      const db = e.target.result;
      db.createObjectStore('vault');
    };
    dbReq.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('vault', 'readwrite');
      tx.objectStore('vault').put(handle, 'folder');
      document.cookie = 'access=true';
    };
  }

  function restoreAccess() {
    if (!document.cookie.includes('access=true')) return;
    const dbReq = indexedDB.open('advaultDB', 1);
    dbReq.onsuccess = e => {
      const db = e.target.result;
      const tx = db.transaction('vault', 'readonly');
      tx.objectStore('vault').get('folder').onsuccess = async ev => {
        const h = ev.target.result;
        if (h && (await h.queryPermission({ mode: 'read' })) === 'granted') {
          showDirectory(h);
        }
      };
    };
  }

  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('sw.js');
  }

  window.onload = restoreAccess;
  </script>
</body>
</html>
