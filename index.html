<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>File Explorer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.json">
  <style>
    body { margin:0; font-family: monospace; background:#111; color:#eee; display:flex; flex-direction:column; height:100vh; }
    header { background:#222; padding:10px; display:flex; gap:10px; align-items:center; }
    button, input { background:#333; color:#0f0; border:none; padding:8px 12px; border-radius:4px; cursor:pointer; }
    #breadcrumbs { flex:1; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; }
    #search { flex:1; }
    main { flex:1; overflow-y:auto; padding:10px; }
    .entry { padding:6px; margin:4px 0; background:#1a1a1a; border:1px solid #444; border-radius:4px; cursor:pointer; display:flex; align-items:center; }
    .entry:hover { background:#333; }
    .entry .icon { width:20px; margin-right:8px; }
    #viewer { padding:10px; border-top:1px solid #444; overflow:auto; }
    pre, img, audio, video { max-width:100%; margin-top:10px; }
  </style>
</head>
<body>
  <header>
    <button onclick="pickFolder()">üìÇ Open</button>
    <button onclick="goUp()">‚¨ÜÔ∏è Up</button>
    <div id="breadcrumbs">/</div>
    <input type="text" id="search" placeholder="Search..." oninput="renderEntries()">
  </header>
  <main id="list"></main>
  <div id="viewer"></div>
  <script>
    let dirStack = [], currentHandle, entries = [];

    async function pickFolder() {
      try {
        const handle = await window.showDirectoryPicker();
        dirStack = [handle];
        await loadEntries();
      } catch {}
    }

    async function loadEntries() {
      currentHandle = dirStack[dirStack.length-1];
      document.getElementById('breadcrumbs').textContent = '/' + dirStack.map(h=>h.name).join('/');
      entries = [];
      for await (const [name, h] of currentHandle.entries()) {
        entries.push({ name, handle:h, kind:h.kind });
      }
      renderEntries();
      document.getElementById('viewer').innerHTML = '';
    }

    function renderEntries() {
      const q = document.getElementById('search').value.toLowerCase();
      const list = document.getElementById('list');
      list.innerHTML = '';
      entries
        .filter(e=>e.name.toLowerCase().includes(q))
        .sort((a,b)=> a.kind===b.kind? a.name.localeCompare(b.name) : a.kind==='directory'? -1:1)
        .forEach(e=>{
          const div = document.createElement('div');
          div.className='entry';
          div.innerHTML = `<span class="icon">${e.kind==='directory'?'üìÅ':'üìÑ'}</span>${e.name}`;
          div.onclick = ()=> e.kind==='directory'? enterDir(e.handle) : openFile(e.handle);
          list.appendChild(div);
        });
    }

    async function enterDir(handle) {
      dirStack.push(handle);
      await loadEntries();
    }

    function goUp() {
      if(dirStack.length>1){ dirStack.pop(); loadEntries(); }
    }

    async function openFile(handle) {
      const file = await handle.getFile();
      const ext = file.name.split('.').pop().toLowerCase();
      const viewer = document.getElementById('viewer');
      viewer.innerHTML = '';
      if(/^(txt|md|json|csv|html|js|css|py)$/.test(ext)){
        const text = await file.text();
        viewer.innerHTML=`<pre>${text.replace(/[&<"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m])}</pre>`;
      } else if(/^(png|jpe?g|gif|webp)$/.test(ext)){
        const url=URL.createObjectURL(file);
        viewer.innerHTML=`<img src="${url}">`;
      } else if(/^(mp3|wav|ogg)$/.test(ext)){
        const url=URL.createObjectURL(file);
        viewer.innerHTML=`<audio controls src="${url}"></audio>`;
      } else if(/^(mp4|webm|ogg)$/.test(ext)){
        const url=URL.createObjectURL(file);
        viewer.innerHTML=`<video controls src="${url}" style="max-height:40vh;"></video>`;
      } else {
        viewer.textContent='Unsupported type';
      }
    }

    // register service worker
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('sw.js');
    }
  </script>
</body>
</html>
